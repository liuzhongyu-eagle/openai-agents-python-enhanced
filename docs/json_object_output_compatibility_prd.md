# Agent 结构化输出兼容性增强 PRD

## 1. 产品概述

### 1.1 背景
当前 OpenAI Agents SDK 在处理结构化输出时，默认使用完整的 JSON Schema 格式（`{'type': 'json_schema', 'json_schema': {...}}`）。然而，许多第三方 LLM 供应商仅支持简化的 JSON 对象格式（`{'type': 'json_object'}`），这导致了兼容性问题。

### 1.2 问题描述
- **兼容性限制**：第三方供应商不支持完整的 JSON Schema 定义
- **功能缺失**：用户无法在这些供应商上使用 SDK 的结构化输出功能
- **开发体验差**：需要手动处理 JSON 解析和验证

### 1.3 产品目标
提供一个优雅的解决方案，使 SDK 能够兼容仅支持 `json_object` 格式的 LLM 供应商，同时保持现有功能的完整性和易用性。

## 2. 用户场景

### 2.1 主要用户群体
- **企业开发者**：使用私有部署或第三方 LLM 服务的开发者
- **多云用户**：需要在不同 LLM 供应商间切换的用户
- **成本敏感用户**：选择更经济的第三方 LLM 服务的用户

### 2.2 核心用例

#### 用例 1：第三方供应商集成
```python
# 用户希望使用仅支持 json_object 的供应商
agent = Agent(
    name="DataProcessor",
    instructions="处理用户数据并返回结构化结果",
    output_type=JsonObjectOutputSchema(UserProfile),  # 新增的兼容性类
    model=ThirdPartyModel()  # 仅支持 json_object 的供应商
)
```

#### 用例 2：多供应商兼容
```python
# 用户希望代码能在不同供应商间无缝切换
def create_agent(model_provider):
    if model_provider.supports_json_schema():
        output_schema = AgentOutputSchema(UserProfile)
    else:
        output_schema = JsonObjectOutputSchema(UserProfile)
    
    return Agent(output_type=output_schema, model=model_provider)
```

#### 用例 3：智能降级策略
```python
# 用户希望优先使用 json_schema，但在不支持时自动降级到 json_object
agent = Agent(
    output_type=AgentOutputSchema(
        target_type=UserProfile,
        fallback_to_json_object=True  # 如果供应商不支持 json_schema，自动降级
    )
)
```

## 3. 功能需求

### 3.1 核心功能

#### 3.1.1 智能降级机制（主要功能）
- **优先策略**：默认优先使用完整的 `json_schema` 格式
- **自动检测**：检测 LLM 供应商是否支持 `json_schema`
- **智能降级**：不支持时自动降级到 `json_object` 格式
- **透明切换**：用户代码无需修改即可适配不同供应商
- **性能优化**：`json_schema` 模式提供更好的验证性能

#### 3.1.2 JsonObjectOutputSchema 类（兼容性支持）
- **继承关系**：继承自 `AgentOutputSchemaBase`
- **核心职责**：
  - 向 LLM 供应商声明输出格式为 `{'type': 'json_object'}`
  - 在本地对 LLM 返回的 JSON 进行严格验证
  - 支持任意 Python 类型（Pydantic 模型、dataclass、TypedDict 等）
- **使用场景**：明确知道供应商仅支持 `json_object` 的特殊情况

#### 3.1.3 智能提示生成
- **自动生成指令**：基于目标类型自动生成 JSON 结构描述
- **多语言支持**：支持中文、英文等多种语言的指令生成
- **示例生成**：自动生成 JSON 输出示例
- **条件激活**：仅在降级到 `json_object` 模式时激活

#### 3.1.4 统一验证机制
- **类型验证**：使用 Pydantic TypeAdapter 进行严格类型检查
- **错误处理**：提供详细的验证错误信息
- **性能优化**：缓存验证器以提高性能
- **模式无关**：无论使用 `json_schema` 还是 `json_object` 都提供一致的验证

### 3.2 扩展功能

#### 3.2.1 智能降级模式
- **优先使用 json_schema**：默认尝试使用完整的 JSON Schema 功能
- **自动降级到 json_object**：当供应商不支持时自动降级
- **透明切换**：用户无需修改代码即可适配不同供应商
- **性能优化**：json_schema 模式提供更好的验证性能和准确性

#### 3.2.2 调试支持
- **详细日志**：记录 response_format 选择过程
- **验证追踪**：追踪 JSON 验证的详细过程
- **错误诊断**：提供 LLM 输出问题的诊断信息

## 4. 技术要求

### 4.1 兼容性要求
- **向后兼容**：不影响现有 `AgentOutputSchema` 的功能
- **API 稳定性**：新增功能不破坏现有 API
- **类型安全**：保持完整的类型提示支持

### 4.2 性能要求
- **验证性能**：JSON 验证延迟 < 10ms（对于常见数据结构）
- **内存效率**：避免不必要的数据复制
- **缓存机制**：缓存编译后的验证器

### 4.3 可靠性要求
- **错误处理**：优雅处理各种异常情况
- **降级策略**：在验证失败时提供合理的降级方案
- **测试覆盖**：单元测试覆盖率 > 95%

## 5. 非功能性需求

### 5.1 易用性
- **简单配置**：一行代码即可启用兼容模式
- **清晰文档**：提供详细的使用指南和最佳实践
- **示例丰富**：提供多种使用场景的示例代码

### 5.2 可维护性
- **模块化设计**：功能模块清晰分离
- **代码质量**：遵循项目现有的代码规范
- **文档完整**：代码注释和文档完整

### 5.3 扩展性
- **插件机制**：支持自定义验证逻辑
- **配置灵活**：支持多种配置选项
- **未来兼容**：为未来的功能扩展预留接口

## 6. 成功指标

### 6.1 功能指标
- **兼容性覆盖**：支持 90% 以上的主流第三方 LLM 供应商
- **类型支持**：支持所有常见的 Python 类型定义
- **验证准确性**：JSON 验证准确率 > 99%

### 6.2 性能指标
- **响应时间**：不增加超过 5% 的总体响应时间
- **内存使用**：内存开销增加 < 10%
- **CPU 使用**：CPU 开销增加 < 5%

### 6.3 用户体验指标
- **采用率**：新功能在发布后 3 个月内被 30% 的用户采用
- **满意度**：用户反馈满意度 > 4.5/5
- **问题报告**：相关 bug 报告 < 5 个/月

## 7. 风险评估

### 7.1 技术风险
- **验证复杂性**：复杂类型的验证可能存在边界情况
- **性能影响**：额外的验证步骤可能影响性能
- **兼容性问题**：不同供应商的 json_object 实现可能存在差异

### 7.2 业务风险
- **用户混淆**：多种输出模式可能导致用户选择困难
- **维护成本**：增加代码复杂性和维护成本
- **文档负担**：需要额外的文档和示例维护

### 7.3 缓解策略
- **充分测试**：建立完善的测试用例覆盖各种场景
- **性能监控**：建立性能基准和监控机制
- **用户指导**：提供清晰的选择指南和最佳实践
- **渐进发布**：采用渐进式发布策略，收集用户反馈

## 8. 实施计划

### 8.1 开发阶段
1. **设计阶段**（1 周）：详细技术设计和 API 设计
2. **核心开发**（2 周）：实现 JsonObjectOutputSchema 核心功能
3. **集成测试**（1 周）：与现有系统集成和测试
4. **文档编写**（1 周）：编写用户文档和示例

### 8.2 验证阶段
1. **单元测试**：确保所有功能正确实现
2. **集成测试**：验证与不同供应商的兼容性
3. **性能测试**：验证性能要求达标
4. **用户测试**：邀请部分用户进行 beta 测试

### 8.3 发布阶段
1. **文档发布**：更新官方文档
2. **示例发布**：发布示例代码和教程
3. **社区通知**：通过各种渠道通知用户新功能
4. **反馈收集**：建立反馈收集机制

## 9. 附录

### 9.1 相关技术标准
- JSON Schema Draft 7
- OpenAI API 规范
- Pydantic 验证机制

### 9.2 参考资料
- OpenAI Structured Outputs 文档
- 第三方 LLM 供应商 API 文档
- Python 类型系统最佳实践
